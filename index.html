<!DOCTYPE html>
<html>
    <head>
            <meta http-equiv="cache-control" content="max-age=0" />
            <meta http-equiv="cache-control" content="no-cache" />
            <meta http-equiv="expires" content="0" />
            <meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
            <meta http-equiv="pragma" content="no-cache" />
        <meta charset="utf-8">
        <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css" />
        <link rel="stylesheet" type="text/css" href="css/main.css?l=1" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">


    </head>
    <body>

        
        <div class="modal fade" id="dataFit">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                
                    <div class="modal-header">
                        <h5 clas="modal-title">Ajuste de datos</h5>
                    </div>
                    <div class="modal-body">
                        <div class="container-fluid">
                            <div class="row">
                                    <div class="col-md-4">Tabla:</div>
                                    <div class="col-md-8">
                                        <select name="table_select_datafit" id="table_select_datafit">
                                            
                                        </select>
                                    </div>
                                </div>
                            <div class="row">
                                <div class="col-md-4">X:</div>
                                <div class="col-md-8">
                                    <select name="x_axis_datafit" id="x_axis_select_datafit">
                                    </select>
                                </div>
                            </div>
                            <div class="row">
                                    <div class="col-md-4">Y:</div>
                                    <div class="col-md-8">
                                        <select name="y_axis_datafit" id="y_axis_select_datafit">
                                        </select>
                                    </div>
                            </div>

                            <div class="row">
                                <div class="col-md-4">Expresión:</div>
                                <div class="col-md-8">
                                    <input type="text" class="form-control" id="data_fit_function" placeholder="a*x+b">
                                </div>
                            </div>
                            <div class="row">
                                    <div class="col-md-4">Valores iniciales:</div>
                                    <div class="col-md-8">
                                        <input type="text" class="form-control" id="data_fit_hints" placeholder="a=1, b=2">
                                        <small class="form-text text-muted">(Variable)=(valor inicial). Separados por comas.</small>
                                    </div>
                            </div>
                            <div class="row">
                                    <div class="col-*-4">
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input" type="checkbox" id="modal-datafit-create-graphic" value="option1">
                                                <label class="form-check-label" for="modal-datafit-create-graphic">Crear gráfica</label>
                                            </div>
                                    </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" data-dismiss="modal" type="button">Cancelar</button>
                        <button class="btn btn-primary" type="button" id="btn-fit">Ajustar</button>
                    </div>
                </div>
                
            </div>
        </div>
        <div class="modal fade" id="dataGraph">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                
                    <div class="modal-header">
                        <h5 class="modal-title">Representar datos</h5>
                    </div>
                    <div class="modal-body">
                        <div class="container-fluid">
                            <div class="row">
                                    <div class="col-md-4">Tabla:</div>
                                    <div class="col-md-8">
                                        <select name="table_select" id="table_select">
                                            
                                        </select>
                                    </div>
                                </div>
                            <div class="row">
                                <div class="col-md-4">X:</div>
                                <div class="col-md-8">
                                    <select name="x_axis" id="x_axis_select">
                                    </select>
                                </div>
                            </div>
                            <div class="row">
                                    <div class="col-md-4">Y:</div>
                                    <div class="col-md-8">
                                        <select name="y_axis" id="y_axis_select">
                                        </select>
                                    </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" data-dismiss="modal" type="button">Cancelar</button>
                        <button class="btn btn-primary" type="button" id="btn-graphic-create">Crear gráfica</button>
                    </div>
                </div>
                
            </div>
        </div>

        <div class="modal fade" id="dataInfo">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                    
                        <div class="modal-header">
                            <h5 class="modal-title" id="dataInfo_title"></h5>
                        </div>
                        <div class="modal-body">
                            <div class="container-fluid" id="dataInfo_container">
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-primary" data-dismiss="modal" type="button">Aceptar</button>
                        </div>
                    </div>
                    
                </div>
            </div>


        
        
            <div class="container-custom">
                    <div class="alert alert-warning alert-fixed" id="alerta-div" role="alert">
                            Alerta!    
                        </div>
                
                    <div class="row">
                        <nav class="col-md-12 col-xs-12 navbar navbar-expand-lg navbar-light bg-light navbar-custom">
                          <a class="navbar-brand" href="#">DateAble</a>
                          <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
                            <span class="navbar-toggler-icon"></span>
                          </button>
                          <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
                            <div class="navbar-nav">
                              <a class="nav-item nav-link active" href="#">Inicio <span class="sr-only">(current)</span></a>
                              <a class="nav-item nav-link" href="#" data-toggle="modal" data-target="#dataFit">Ajuste</a>
                              <a class="nav-item nav-link" href="#" data-toggle="modal" data-target="#dataGraph">Gráfica</a>
                              <a class="nav-item nav-link" href="#">Ayuda</a>
                              <a class="nav-item nav-link" href="#">Información</a>
                             </div>
                          </div>
                        </nav>
                    </div>

                    <div class="row">
                    <div class="col-md-6" style="background-color:#FFF" id="data">
                    
                    
                    </div>

                    <div class="col-md-6" style="background-color:#FFF" id="graphics">
                    
                    
                        </div>
                    </div>
            </div>
            

        <script src="jquery/jquery.min.js"></script>
        <script src="jquery/jquery-ui/jquery-ui.min.js"></script>
        
        <script type="text/javascript" src="js/bootstrap.min.js"></script>
        <script type="text/javascript" src="js/GradientFit.js?k=1"></script>
        <script type="text/javascript">

        TableController.topElement=0;
        
        TableController.TableNumber=0;
        TableController.currentTableNumber=0;
        TableController.instances = [];
        function TableController(_initialConfiguration){
            let initialConfiguration = {
                    columns: 2,
                    rows: 10
            };
            if(void 0 !== _initialConfiguration){
                if(void 0 !== _initialConfiguration.title){
                    initialConfiguration.title = _initialConfiguration.title;
                }
                if(void 0 !== _initialConfiguration.columns){
                    initialConfiguration.columns = _initialConfiguration.columns;
                }
                if(void 0 !== _initialConfiguration.rows){
                    initialConfiguration.rows = _initialConfiguration.rows;
                }
            }

            this.configuration = {
                columns: 0,
                rows:0
            };
            
            

            this.position={x:1, y:1};
            
            this.tableId = TableController.TableNumber++;
            TableController.instances[this.tableId] = this;
            this.element=this.makeTable(initialConfiguration);


            // JQuery draggable effect
            $(this.element).draggable({
                start: function() {
                    $(this).css({"background" : "rgba(210,210,210,0.9)"})
                },
                stop: function() { 
                    $(this).css({"background" : "rgba(200,200,200,0.9)"})
                }
            });

            
            this.element.onclick=(function(event){
                TableController.currentTableNumber=this.tableId;
                if(event.target.className==="data_table_input"){
                    let m = event.target.id.match(/table_(\d*)_(\d*)_(\d*)/);
                    this.position.x=m[2];
                    this.position.y=m[3];
                    this.updatePosition();
                }

            }).bind(this);

            this.element.onkeydown=()=>{
                
                let keyCode = event.keyCode;
                if(keyCode>36 && keyCode<41){
                    if(keyCode==37){                   //Left
                        if(this.position.x>1){
                            this.position.x--;
                        }
                    }
                    if(keyCode==38){                   //Top
                        if(this.position.y>1){
                            this.position.y--;
                        }

                    }
                    if(keyCode==39){                   //Right
                        if(this.position.x<this.configuration.columns){
                            this.position.x++;
                        }else{
                            this.addColumn();
                            this.position.x++;
                        }
                    }
                    if(keyCode==40){                   //Bottom
                        if(this.position.y<this.configuration.rows){
                            this.position.y++;
                        }else{
                            this.addRow();
                            this.position.y++;                        
                        }

                    }                
                    this.updatePosition();
                }
            };
            
        };
        
        TableController.prototype.makeTable=function(initialConfiguration){
            let elm, elmC;
            elm = document.createElement("div");
            elm.className="data_window";

            elmC=document.createElement("span");
            elmC.setAttribute("class","data_window_title");
            elmC.append(document.createTextNode("Tabla "+this.tableId));
            elm.append(elmC);
            
            elmC=document.createElement("span");
            elmC.setAttribute("class","close_button");
            elmC.append(document.createTextNode("×"));    // Close button
            elm.append(elmC);

            elm.append(document.createElement("br"));

            elmC=document.createElement("div");
            elmC.className="data_table";
            elm.append(elmC);
            this.dataTableElement=elmC;


            TableController.topElement.append(elm);
            
            this.element=elm;

            let i=this.configuration.columns;
            let j=1;
            while(j<=initialConfiguration.columns){
                if(void 0 === initialConfiguration.columnsTitle || 0 === initialConfiguration.columnsTitle[j]){
                    this.addColumn("Columna "+this.configuration.columns);
                }else{
                    this.addColumn(initialConfiguration.columnsTitle[j]);
                }
                
                j++;
            }

            j=0;
            while(j<initialConfiguration.rows){
               this.addRow();
               j++;
            }
            this.position.x=this.position.y=1;
            this.updatePosition();
            return elm;
        };

        TableController.prototype.addColumn=function(title){

            
            let elm;
            elm=document.createElement("div");
            elm.className="data_table_col";
            elmC = document.createElement("input");
            elmC.className="data_table_title";
            elmC.setAttribute("id","table_"+this.tableId+"_title_"+(++this.configuration.columns));
            
            if(void 0 === title){
                title = "#"+this.configuration.columns;
            }

            elmC.value = title;
            elm.append(elmC);
            this.dataTableElement.append(elm);
            this.addRowColumn(this.configuration.columns);
        }

        TableController.prototype.addRowColumn=function(j){
            let childrens=this.dataTableElement.children;
            let input;
            let i=1;
            while(i<=this.configuration.rows){
                input = document.createElement("input");
                input.setAttribute("type","text");
                input.setAttribute("id","table_"+this.tableId+"_"+j+"_"+i++);
                input.setAttribute("class","data_table_input");
                childrens[j-1].append(input);
            }  
        }


        TableController.prototype.addRow=function(){
            let childrens=this.dataTableElement.children;
            let i = childrens.length;
            let j=0;
            let input;
            this.configuration.rows++;

            while(j<i){
                input = document.createElement("input");
                input.setAttribute("type","text");
                input.setAttribute("id","table_"+this.tableId+"_"+(j+1)+"_"+this.configuration.rows);
                input.setAttribute("class","data_table_input");
                childrens[j++].append(input);
            }  
        }

        TableController.prototype.updatePosition=function(){
            document.getElementById("table_"+this.tableId+"_"+this.position.x+"_"+this.position.y).select();
        };

        TableController.getTablesNumber=function(){
            return TableController.TableNumber;
        }

        TableController.getTableInstance=function(tableId){
            if(tableId < TableController.instances.length){
                return TableController.instances[tableId];
            }
            return void 0;

        }

        TableController.prototype.getColumnsNames=function(tableId){
            let elm = this.dataTableElement.getElementsByClassName("data_table_title");
            let i = elm.length;
            let j = 0;
            let names = [];
            while(j<i){
                names[j] = ("" == elm[j].value) ? "Columna "+j : elm[j].value;
                j++;

            }
            return names;
        }
        /**
         * Function: getData
         * Returns a [COLSxROW] array with all values in the table.
         * If value is not inserted, treated as undefined.
         * If value is NaN, treated as undefined.
         */
        TableController.prototype.getData = function(){
            let dataArray=[];
            let n = this.configuration.columns;
            let j;
            while(n--){
                dataArray[n] = [];
                j = this.configuration.rows;
                while(j--){
                    dataArray[n][j]=parseFloat(document.getElementById("table_"+this.tableId+"_"+(n+1)+"_"+(j+1)).value);
                    dataArray[n][j]= (dataArray[n][j]) ? dataArray[n][j] : void 0;
                }
            }
            

            return dataArray;

        };


        TableController.createTable=function(){
            new TableController();
        }
        </script>
        <script languaje="javascript" src="js/window.js?k=7"></script>
        <script languaje="javascript" src="js/grafika.js?k=6"></script>
        <script languaje="JavaScript">
        /*
         *  Table-Graphics Interface
         * 
         */

        plotPoints.numOfPlots = 0;
        function plotPoints(data){
            let tableInstance = TableController.getTableInstance(data.tableId);
            let columnsNames = tableInstance.getColumnsNames();
            let tableData = tableInstance.getData();
            let useData = [tableData[data.columnX],tableData[data.columnY]];
            console.log(useData);
            // Parse data
            let n = useData[0].length;
            let j = 0;
            let validData = {x:[], y: []};
            while(n--){
                if(void 0 === useData[0][n] || undefined ===useData[0][n]){continue;}
                if(void 0 === useData[1][n] || undefined ===useData[1][n]){continue;}
                validData.x[j] = useData[0][n];
                validData.y[j] = useData[1][n];
                j++;
            }
            console.log(validData);
            
            
            let grafikaWindow = new WindowController({title : "Gráfica "+(++plotPoints.numOfPlots)}, document.getElementById("graphics"));
            let grafikaA = new Grafika(validData, {element: grafikaWindow.getCanvas()});
            grafikaA.onError(function(errorInfo){
                alerta("Grafica: "+errorInfo.text);
                grafikaWindow.close()
            });
            
            
        }

        let gradientFit;
        /*
         *  Table-GradientFit-Graphics Interface
         * 
         */

         function fitPoints(data){
            let tableInstance = TableController.getTableInstance(data.tableId);
            let columnsNames = tableInstance.getColumnsNames();
            let tableData = tableInstance.getData();
            let useData = [tableData[data.columnX],tableData[data.columnY]];
            // Parse data
            let n = useData[0].length;
            let j = 0;
            let validData = {x:[], y: []};
            while(n--){
                if(void 0 === useData[0][n] || undefined ===useData[0][n]){continue;}
                if(void 0 === useData[1][n] || undefined ===useData[1][n]){continue;}
                validData.x[j] = useData[0][n];
                validData.y[j] = useData[1][n];
                j++;
            }
            console.log(data.hints);
            
            gradientFit = new GradientFit(validData, data.function, data.hints);
            let result = gradientFit.iterate();
            
            

            informacionModal({
                title : 'Ajuste de datos',
                content: '<div class="col-md-4">Función:</div><div class="col-md-8">'+gradientFit.getTextFunction()+'</div>'
            });
            
        }

        </script>
        <script languaje="JavaScript">
            // VISTA
            /*
             * Function: (Document ready)
             *  Sets the events and views 
             */
            $(document).ready(
                function(){
                    TableController.topElement=document.getElementById("data");
                    a = new TableController({
                        columns : 3,
                        rows : 10
                    });            
                    
                    $("#dataGraph").on("shown.bs.modal", function(){
                        
                        $("#table_select").html("");
                        let i = TableController.getTablesNumber();
                        let j = 0;
                        while(j<i){
                            $("#table_select").append("<option value=\""+j+"\">Tabla "+j+"</option>");
                            j++;
                        }

                        $("#table_select").trigger("change");
                    });
                    $("#table_select").on('change', function(){
                        let tableId=document.getElementById("table_select").value;
                        console.log(tableId);
                        let tableInstance = TableController.getTableInstance(tableId);
                        let names = tableInstance.getColumnsNames();
                        let j = 0;
                        let i = names.length;
                        $("#x_axis_select").html("");
                        $("#y_axis_select").html("");
                        while(j<i){
                            $("#x_axis_select").append("<option value=\""+j+"\">"+names[j]+"</option>");
                            $("#y_axis_select").append("<option value=\""+j+"\">"+names[j]+"</option>");
                            j++;

                        }
                    });

                    $("#dataFit").on("shown.bs.modal", function(){
                        
                        $("#table_select_datafit").html("");
                        let i = TableController.getTablesNumber();
                        let j = 0;
                        while(j<i){
                            $("#table_select_datafit").append("<option value=\""+j+"\">Tabla "+j+"</option>");
                            j++;
                        }

                        $("#table_select_datafit").trigger("change");
                    });
                    $("#table_select_datafit").on('change', function(){
                        let tableId=document.getElementById("table_select_datafit").value;
                        console.log(tableId);
                        let tableInstance = TableController.getTableInstance(tableId);
                        let names = tableInstance.getColumnsNames();
                        let j = 0;
                        let i = names.length;
                        $("#x_axis_select_datafit").html("");
                        $("#y_axis_select_datafit").html("");
                        while(j<i){
                            $("#x_axis_select_datafit").append("<option value=\""+j+"\">"+names[j]+"</option>");
                            $("#y_axis_select_datafit").append("<option value=\""+j+"\">"+names[j]+"</option>");
                            j++;

                        }
                    });

                    $("#btn-graphic-create").on("click", function(){
                        plotPoints({
                            tableId:document.getElementById("table_select").value,
                            columnX:document.getElementById("x_axis_select").value,
                            columnY:document.getElementById("y_axis_select").value
                        });
                        $("#dataGraph").modal('close');
                    });

                    $("#btn-fit").on("click",function(){
                        let plotGraph = $("#modal-datafit-create-graphic").is(":checked");
                        let data = {
                            tableId:document.getElementById("table_select_datafit").value,
                            columnX:document.getElementById("x_axis_select_datafit").value,
                            columnY:document.getElementById("y_axis_select_datafit").value,
                            function: document.getElementById("data_fit_function").value,
                            hints: document.getElementById("data_fit_hints").value
                        };
                        fitPoints(data);
                        $("#dataFit").modal("hide");
                    });

                }
            )

            function alerta(msg){
                document.getElementById("alerta-div").innerText = msg;
                document.getElementById("alerta-div").classList.add("alert-open");
                
                setTimeout(function(){
                    document.getElementById("alerta-div").classList.add("alert-close");
                    document.getElementById("alerta-div").classList.remove("alert-open");
                },5000);

            }

            function informacionModal(info){
                if(void 0 === info || void 0 === info.content){
                    return;
                }
                let title, content;
                if(void 0 === info.title){
                    title = "Información"
                }else{
                    title = info.title;
                }
                $("#dataInfo_title").text(title);
                $("#dataInfo_container").html(info.content);
                $("#dataInfo").modal("show");
                
            }
        </script>
    </body>
</html>
